{"version":3,"names":["_element","require","_compose","_blocks","_richText","_url","_utils","_splitValue","_pasting","usePasteHandler","props","propsRef","useRef","current","useRefEffect","element","_onPaste","event","isSelected","disableFormats","onChange","value","formatTypes","tagName","onReplace","onSplit","__unstableEmbedURLOnPaste","preserveWhiteSpace","pastePlainText","plainText","html","files","getPasteEventData","preventDefault","window","console","log","insert","isInternal","clipboardData","getData","pastedValue","create","addActiveFormats","activeFormats","text","length","fromTransforms","getBlockTransforms","blocks","reduce","accumulator","file","transformation","findTransform","transform","type","isMatch","push","flat","isEmpty","splitValue","pastedBlocks","mode","trimmedPlainText","trim","isURL","test","content","pasteHandler","HTML","transformed","accumlator","__unstablePasteRule","valueToInsert","addEventListener","removeEventListener"],"sources":["@wordpress/block-editor/src/components/rich-text/use-paste-handler.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\nimport { useRef } from '@wordpress/element';\nimport { useRefEffect } from '@wordpress/compose';\nimport {\n\tpasteHandler,\n\tfindTransform,\n\tgetBlockTransforms,\n} from '@wordpress/blocks';\nimport { isEmpty, insert, create } from '@wordpress/rich-text';\nimport { isURL } from '@wordpress/url';\n\n/**\n * Internal dependencies\n */\nimport { addActiveFormats } from './utils';\nimport { splitValue } from './split-value';\nimport { getPasteEventData } from '../../utils/pasting';\n\n/** @typedef {import('@wordpress/rich-text').RichTextValue} RichTextValue */\n\nexport function usePasteHandler( props ) {\n\tconst propsRef = useRef( props );\n\tpropsRef.current = props;\n\treturn useRefEffect( ( element ) => {\n\t\tfunction _onPaste( event ) {\n\t\t\tconst {\n\t\t\t\tisSelected,\n\t\t\t\tdisableFormats,\n\t\t\t\tonChange,\n\t\t\t\tvalue,\n\t\t\t\tformatTypes,\n\t\t\t\ttagName,\n\t\t\t\tonReplace,\n\t\t\t\tonSplit,\n\t\t\t\t__unstableEmbedURLOnPaste,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t\tpastePlainText,\n\t\t\t} = propsRef.current;\n\n\t\t\tif ( ! isSelected ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { plainText, html, files } = getPasteEventData( event );\n\n\t\t\tevent.preventDefault();\n\n\t\t\t// Allows us to ask for this information when we get a report.\n\t\t\twindow.console.log( 'Received HTML:\\n\\n', html );\n\t\t\twindow.console.log( 'Received plain text:\\n\\n', plainText );\n\n\t\t\tif ( disableFormats ) {\n\t\t\t\tonChange( insert( value, plainText ) );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst isInternal =\n\t\t\t\tevent.clipboardData.getData( 'rich-text' ) === 'true';\n\n\t\t\t// If the data comes from a rich text instance, we can directly use it\n\t\t\t// without filtering the data. The filters are only meant for externally\n\t\t\t// pasted content and remove inline styles.\n\t\t\tif ( isInternal ) {\n\t\t\t\tconst pastedValue = create( {\n\t\t\t\t\thtml,\n\t\t\t\t\tpreserveWhiteSpace,\n\t\t\t\t} );\n\t\t\t\taddActiveFormats( pastedValue, value.activeFormats );\n\t\t\t\tonChange( insert( value, pastedValue ) );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( pastePlainText ) {\n\t\t\t\tonChange( insert( value, create( { text: plainText } ) ) );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( files?.length ) {\n\t\t\t\t// Allows us to ask for this information when we get a report.\n\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\twindow.console.log( 'Received items:\\n\\n', files );\n\n\t\t\t\tconst fromTransforms = getBlockTransforms( 'from' );\n\t\t\t\tconst blocks = files\n\t\t\t\t\t.reduce( ( accumulator, file ) => {\n\t\t\t\t\t\tconst transformation = findTransform(\n\t\t\t\t\t\t\tfromTransforms,\n\t\t\t\t\t\t\t( transform ) =>\n\t\t\t\t\t\t\t\ttransform.type === 'files' &&\n\t\t\t\t\t\t\t\ttransform.isMatch( [ file ] )\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif ( transformation ) {\n\t\t\t\t\t\t\taccumulator.push(\n\t\t\t\t\t\t\t\ttransformation.transform( [ file ] )\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn accumulator;\n\t\t\t\t\t}, [] )\n\t\t\t\t\t.flat();\n\t\t\t\tif ( ! blocks.length ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif ( onReplace && isEmpty( value ) ) {\n\t\t\t\t\tonReplace( blocks );\n\t\t\t\t} else {\n\t\t\t\t\tsplitValue( {\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t\tpastedBlocks: blocks,\n\t\t\t\t\t\tonReplace,\n\t\t\t\t\t\tonSplit,\n\t\t\t\t\t} );\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet mode = onReplace && onSplit ? 'AUTO' : 'INLINE';\n\n\t\t\tconst trimmedPlainText = plainText.trim();\n\n\t\t\tif (\n\t\t\t\t__unstableEmbedURLOnPaste &&\n\t\t\t\tisEmpty( value ) &&\n\t\t\t\tisURL( trimmedPlainText ) &&\n\t\t\t\t// For the link pasting feature, allow only http(s) protocols.\n\t\t\t\t/^https?:/.test( trimmedPlainText )\n\t\t\t) {\n\t\t\t\tmode = 'BLOCKS';\n\t\t\t}\n\n\t\t\tconst content = pasteHandler( {\n\t\t\t\tHTML: html,\n\t\t\t\tplainText,\n\t\t\t\tmode,\n\t\t\t\ttagName,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t} );\n\n\t\t\tif ( typeof content === 'string' ) {\n\t\t\t\tconst transformed = formatTypes.reduce(\n\t\t\t\t\t( accumlator, { __unstablePasteRule } ) => {\n\t\t\t\t\t\t// Only allow one transform.\n\t\t\t\t\t\tif ( __unstablePasteRule && accumlator === value ) {\n\t\t\t\t\t\t\taccumlator = __unstablePasteRule( value, {\n\t\t\t\t\t\t\t\thtml,\n\t\t\t\t\t\t\t\tplainText,\n\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn accumlator;\n\t\t\t\t\t},\n\t\t\t\t\tvalue\n\t\t\t\t);\n\n\t\t\t\tif ( transformed !== value ) {\n\t\t\t\t\tonChange( transformed );\n\t\t\t\t} else {\n\t\t\t\t\tconst valueToInsert = create( { html: content } );\n\t\t\t\t\taddActiveFormats( valueToInsert, value.activeFormats );\n\t\t\t\t\tonChange( insert( value, valueToInsert ) );\n\t\t\t\t}\n\t\t\t} else if ( content.length > 0 ) {\n\t\t\t\tif ( onReplace && isEmpty( value ) ) {\n\t\t\t\t\tonReplace( content, content.length - 1, -1 );\n\t\t\t\t} else {\n\t\t\t\t\tsplitValue( {\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t\tpastedBlocks: content,\n\t\t\t\t\t\tonReplace,\n\t\t\t\t\t\tonSplit,\n\t\t\t\t\t} );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\telement.addEventListener( 'paste', _onPaste );\n\t\treturn () => {\n\t\t\telement.removeEventListener( 'paste', _onPaste );\n\t\t};\n\t}, [] );\n}\n"],"mappings":"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"}